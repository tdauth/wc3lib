name: Windows CMake NMake Clang Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    # Run the build every day at 4:00 AM UTC
    - cron: '0 4 * * *'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # The NMake generator requires the Visual Studio command line environment
    - name: Setup Visual Studio environment
      # This action sets up the necessary environment variables (like PATH, INCLUDE, LIB)
      # so that NMake can find the required tools (even Clang/LLVM, as they are integrated)
      uses: microsoft/setup-msbuild@v1.1

    - name: Configure CMake with Clang (NMake Generator)
      # We still set the compiler variables to ensure Clang is used, 
      # but the generator is NMake Makefiles
      run: cmake -B build -G "NMake Makefiles" -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
      env:
        CC: clang
        CXX: clang++

    - name: Build project
      # Use the --build command to run NMake
      run: cmake --build build --config Release

    - name: Run tests (optional)
      run: cmake --test build
      
    - name: Run CPack to generate installer
      shell: cmd
      run: |
        REM Re-establish the VS environment for the packaging step
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

        REM Run CPack to create the installer/package
        cmake --build build --target package --config Release

    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: wc3lib-Installer
        path: build/*.exe # Adjust path/extension based on your CPack generator
